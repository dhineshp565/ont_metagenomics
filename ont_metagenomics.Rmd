---
title: "Bov Results Report"
author: "Generated using [ont_metagenomics](https://github.com/dhineshp565/ont_metagenomics) pipeline"
date: "`r Sys.Date()`"
output: 
  html_document:
  output_file: "Metagenomics_report_`r Sys.Date()`.html"
params:
  csv: ""
  krona: ""
---

```{r setup, include=FALSE}

library(knitr)
library(base64enc)
library(htmltools)
library(kableExtra)
library(dplyr)
```


<br>
```{css, echo=FALSE}
.table caption {
    color: darkblue;
    font-weight: bold;
}
```

### Click dropdown to select sample {.tabset .tabset-dropdown}
```{r, results='asis',echo=FALSE}

samplelist <- read.csv(params$csv,header=FALSE,sep = ',')[-1,]
sampleid <- samplelist[,c(1)]

for (i in sampleid){
  cat("####", i, "\n")
  
  # display bracken results
  
  bracken_id <- (paste(i,"_bracken.tsv",sep=""))
  bracken_raw <- read.csv(bracken_id,header = TRUE,sep = "\t")
  bracken_final <- bracken_raw[,c(1,2,6,7)]
  colnames(bracken_final) <- c("Organsim","Taxid","Total reads", "Relative abundance (%)")
  bracken_final[,4] <- paste0((bracken_final[,4] * 100), "%")
  print(knitr::kable(bracken_final,align = "lccc",caption = "Bracken Species Abundance Table.Generated using kraken2 (kraken2 (https://ccb.jhu.edu/software/kraken2/) and Bracken (https://doi.org/10.7717/peerj-cs.104)") 
  %>%
    kable_styling())

  cat('\n\n<!-- -->\n\n')

  # display blast results
  blast_ids <- (paste(i,"_report_blast_best.tsv",sep=""))
  blast_raw <- read.csv(blast_ids,header = TRUE,sep = "\t")
  blast_final <- blast_raw[,c(1,3,4,5,6,7,10)]
  colnames(blast_final) <- c("QUERY_ID","LENGTH","%COVERAGE","%IDENTITY","E_VAL","TAXIDS","STITLE")

  # Sort by taxids
  blast_final <- blast_final %>%
  arrange(`QUERY_ID`)
  print(knitr::kable(blast_final,align = "lccccl",caption = "Consensus compared to custom NCBI BLAST database containing REFSEQ (Prokaryotes,Virus,Fungi,Protozoa). Generated using [BLAST](https://blast.ncbi.nlm.nih.gov/Blast.cgi)")) 
  
  cat('\n\n<!-- -->\n\n')
} 
```
<br>
## Taxonomic classification of raw reads using [Kraken2](https://ccb.jhu.edu/software/kraken2/) and visualization using [Krona](https://link.springer.com/article/10.1186/1471-2105-12-385)


```{r, echo=FALSE}
library("htmltools")
htmltools::tags$iframe(
  src = base64enc::dataURI(file= params$krona, mime="text/html; charset=UTF-8"),
  style="border:10; position:relative; top:0; left:; right::; bottom:; width:100%; height:800px"
)
```
<br>

